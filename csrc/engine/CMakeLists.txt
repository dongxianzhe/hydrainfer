include(pybind_extension)
include(cc_library)
include(cc_test)

cc_library(
  NAME 
    engine
  HDRS
    engine.h
  SRCS
    engine.cpp
  DEPS
    :common
    :memory
    :tokenizer
    Folly::folly
    absl::time
    absl::synchronization
    glog::glog
    torch
  COPTS
    -fPIC
)

cc_test(
  NAME
    engine_test
  SRCS
    engine_test.cpp
  DEPS
    :engine
    GTest::gtest_main
)

cc_test(
  NAME
    stage_test
  SRCS
    stage_test.cpp
  DEPS
    GTest::gtest_main
    torch
)

cc_test(
  NAME
    sequence_test
  SRCS
    sequence_test.cpp
  DEPS
    GTest::gtest_main
    torch
)

pybind_extension(
  NAME
    fast_engine
  COPTS
    -DPY_MODULE_NAME=fast_engine
  SRCS
    engine_pybind.cpp
  DEFINES 
    PYBIND11_DETAILED_ERROR_MESSAGES=1
  LINKDIRS
    ${TORCH_INSTALL_PREFIX}/lib
  DEPS
    :engine
    torch
    torch_python
    absl::strings
    gflags::gflags
    glog::glog
    Python::Module
)